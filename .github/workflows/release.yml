name: Build, tag and attach releases

on:
  release:
    types: [published]

jobs:
  create-phar:
    runs-on: ubuntu-latest
    name: Create Mozart phar
    steps:
      - uses: actions/checkout@v4

      - name: Install PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.5

      - name: Install dependencies
        run: composer install --no-dev --prefer-dist --no-suggest --no-progress

      - name: Create .phar
        run: |
          set -e
          wget -O phar-composer.phar https://github.com/clue/phar-composer/releases/download/v1.2.0/phar-composer-1.2.0.phar
          chmod +x phar-composer.phar
          mkdir -p build
          mv vendor build/vendor
          mv src build/src
          mv bin build/bin
          mv composer.json build

          # Build PHAR with error output
          echo "Building PHAR file..."
          php -d phar.readonly=off phar-composer.phar build ./build/ 2>&1 || {
            echo "PHAR build failed. Checking build directory:"
            ls -la build/
            echo "Checking for composer.json:"
            cat build/composer.json || echo "composer.json not found in build/"
            exit 1
          }

          # Verify phar was created
          if [ ! -f "mozart.phar" ]; then
            echo "Error: mozart.phar was not created"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi

          echo "✓ PHAR file created successfully"
          ls -lh mozart.phar

      - name: Test run mozart
        run: php mozart.phar --version

      - uses: meeDamian/github-release@2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: mozart.phar
          gzip: false
          allow_override: true
  docker:
    uses: ./.github/workflows/docker-build-and-tag.yml
    with:
      version: ${{ github.event.release.tag_name }}
      build_date: ${{ github.event.release.published_at }}
      vcs_ref: ${{ github.sha }}
      source_url: ${{ github.event.repository.html_url }}
    secrets: inherit

  update-release-notes:
    runs-on: ubuntu-latest
    needs: docker
    if: success()
    steps:
      - name: Update release notes with Docker images
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          DOCKER_IMAGE=coenjacobs/mozart
          GHCR_IMAGE=ghcr.io/${{ github.repository_owner }}/mozart

          # Build Docker image information
          DOCKER_INFO="## Docker Images

          This release includes Docker images for multiple architectures (linux/amd64, linux/arm64, linux/arm/v7).

          ### Pull from Docker Hub
          \`\`\`bash
          docker pull ${DOCKER_IMAGE}:${VERSION}
          \`\`\`

          ### Pull from GitHub Container Registry
          \`\`\`bash
          docker pull ${GHCR_IMAGE}:${VERSION}
          \`\`\`

          ### Available Tags
          - \`${VERSION}\` - This release
          "

          # For stable releases, add latest tag info
          if [ "${{ needs.docker.outputs.is_prerelease }}" = "false" ]; then
            DOCKER_INFO="${DOCKER_INFO}
          - \`latest\` - Latest stable version (if this is the highest version)
          "
          fi

          DOCKER_INFO="${DOCKER_INFO}
          ### Links
          - [Docker Hub](https://hub.docker.com/r/${DOCKER_IMAGE}/tags)
          - [GitHub Container Registry](https://github.com/${{ github.repository }}/pkgs/container/mozart)
          "

          # Get current release body
          CURRENT_BODY=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }}" | \
            jq -r '.body // ""')

          # Append Docker info to release body (avoid duplicates)
          if [[ "$CURRENT_BODY" != *"## Docker Images"* ]]; then
            NEW_BODY="${CURRENT_BODY}

          ${DOCKER_INFO}"

            # Update release
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }}" \
              -d "{\"body\": $(echo "$NEW_BODY" | jq -Rs .)}"

            echo "✓ Release notes updated with Docker image information"
          else
            echo "✓ Docker image information already present in release notes"
          fi
